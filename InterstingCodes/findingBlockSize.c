#include <stdio.h>
#include <stdint.h>
#include <x86intrin.h>
#include <time.h>

#define N 512

uint64_t rdtsc(void){
    uint32_t lo, hi;
    _asm_ _volatile_ ("rdtsc" : "= a" (lo), "= d" (hi));
    return ((uint64_t)lo | ((uint64_t)hi << 32));
}

int main(){
    // Time fns
    uint64_t t1, t2,lat[N];
    t1 = 0; t2 = 0;
    // Char to access every byte
    char *arr = (char *)malloc(N*sizeof(char));
    char tmp;
    // Initialise
    for (int i = 0; i < N; i++){
        arr[i] = 0;
        lat[i] = 0;
    }
    // Run tests 100 times to remove noise
    for(int i = 0; i < 2; i++){
        // Flush Cache line
        for (int i = 0; i<N; i++){
            _mm_mfence();
            _mm_clflush(&arr[i]);
            _mm_mfence();
        }
        // Access memory and record time
        for (int i = 0; i<N; i++){
            _mm_mfence();
            t1 = rdtsc();
            _mm_mfence();
            tmp = arr[i];
            _mm_mfence();
            t2 = rdtsc();
            _mm_mfence();
            lat[i] += (t2 - t1);
        }
    }
    // Print time
    for (int i = 0; i<N; i++)
        printf("%d  %lu \n", i, lat[i]/2);
    // Free
    free(arr);
    return 0;
}

// References:
// 1. https://software.intel.com/sites/landingpage/IntrinsicsGuide/
// 2. Pg : 262 -> https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-system-programming-manual-325384.pdf
// 3. https://stackoverflow.com/questions/13772567/how-to-get-the-cpu-cycle-count-in-x86-64-from-c

// To Run
// $ gcc -O0 bsize.c && ./a.out

// 0  529          //cold miss
// 1  242
// 2  366
// 3  246
// 4  244
// 5  244
// 6  243
// 7  245
// 8  243
// 9  243
// 10  243
// 11  247
// 12  245
// 13  248
// 14  247
// 15  246
// 16  244
// 17  244
// 18  243
// 19  247
// 20  246
// 21  246
// 22  248
// 23  247
// 24  246
// 25  247
// 26  245
// 27  247
// 28  246
// 29  246
// 30  248
// 31  246
// 32  245
// 33  244
// 34  244
// 35  242
// 36  242
// 37  246
// 38  244
// 39  246
// 40  245
// 41  249
// 42  243
// 43  246
// 44  246
// 45  244
// 46  245
// 47  247
// 48  253
// 49  240
// 50  243
// 51  245
// 52  245
// 53  243
// 54  242
// 55  244
// 56  247
// 57  243
// 58  244
// 59  246
// 60  243
// 61  242
// 62  247
// 63  245
// 64  241
// 65  244
// 66  241
// 67  248
// 68  243
// 69  241
// 70  243
// 71  243
// 72  249
// 73  249
// 74  245
// 75  246
// 76  248
// 77  245
// 78  250
// 79  246
// 80  251
// 81  246
// 82  249
// 83  244
// 84  246
// 85  244
// 86  246
// 87  244
// 88  245
// 89  246
// 90  244
// 91  245
// 92  248
// 93  245
// 94  244
// 95  248
// 96  247
// 97  246
// 98  249
// 99  247
// 100  248
// 101  248
// 102  247
// 103  244
// 104  244
// 105  246
// 106  246
// 107  248
// 108  245
// 109  248
// 110  246
// 111  246
// 112  449                     //first miss
// 113  242
// 114  244
// 115  244
// 116  242
// 117  246
// 118  241
// 119  242
// 120  242
// 121  242
// 122  245
// 123  242
// 124  242
// 125  244
// 126  247
// 127  245
// 128  246
// 129  243
// 130  241
// 131  242
// 132  244
// 133  246
// 134  247
// 135  241
// 136  243
// 137  246
// 138  249
// 139  245
// 140  244
// 141  244
// 142  244
// 143  248
// 144  245
// 145  243
// 146  245
// 147  246
// 148  245
// 149  247
// 150  244
// 151  248
// 152  246
// 153  246
// 154  245
// 155  247
// 156  244
// 157  249
// 158  247
// 159  249
// 160  249
// 161  247
// 162  246
// 163  247
// 164  249
// 165  246
// 166  245
// 167  243
// 168  246
// 169  244
// 170  244
// 171  247
// 172  248
// 173  248
// 174  244
// 175  246
// 176  251
// 177  243
// 178  241
// 179  244
// 180  244
// 181  244
// 182  244
// 183  244
// 184  244
// 185  242
// 186  241
// 187  246
// 188  241
// 189  244
// 190  241
// 191  244
// 192  242
// 193  241
// 194  244
// 195  243
// 196  244
// 197  244
// 198  241
// 199  241
// 200  246
// 201  247
// 202  246
// 203  247
// 204  244
// 205  243
// 206  246
// 207  247
// 208  248
// 209  246
// 210  247
// 211  246
// 212  244
// 213  244
// 214  250
// 215  243
// 216  246
// 217  246
// 218  248
// 219  245
// 220  248
// 221  245
// 222  247
// 223  242
// 224  245
// 225  245
// 226  247
// 227  246
// 228  247
// 229  245
// 230  247
// 231  246
// 232  242
// 233  248
// 234  244
// 235  244
// 236  242
// 237  244
// 238  243
// 239  244
// 240  363                 //second miss ( second miss - first miss = 240 - 112 = 128 )
// 241  247
// 242  244
// 243  248
// 244  243
// 245  244
// 246  241
// 247  243
// 248  244
// 249  243
// 250  241
// 251  247
// 252  246
// 253  243
// 254  244
// 255  244
// 256  246
// 257  244
// 258  244
// 259  244
// 260  244
// 261  246
// 262  246
// 263  245
// 264  246
// 265  247
// 266  244
// 267  245
// 268  247
// 269  245
// 270  246
// 271  245
// 272  247
// 273  243
// 274  241
// 275  247
// 276  244
// 277  246
// 278  245
// 279  244
// 280  246
// 281  250
// 282  244
// 283  248
// 284  249
// 285  244
// 286  243
// 287  246
// 288  246
// 289  247
// 290  245
// 291  244
// 292  249
// 293  246
// 294  246
// 295  246
// 296  247
// 297  248
// 298  244
// 299  247
// 300  244
// 301  245
// 302  245
// 303  247
// 304  253
// 305  247
// 306  244
// 307  244
// 308  244
// 309  246
// 310  243
// 311  244
// 312  241
// 313  243
// 314  244
// 315  244
// 316  247
// 317  245
// 318  244
// 319  245
// 320  245
// 321  247
// 322  246
// 323  243
// 324  244
// 325  243
// 326  244
// 327  247
// 328  246
// 329  247
// 330  249
// 331  247
// 332  251
// 333  246
// 334  243
// 335  244
// 336  245
// 337  246
// 338  245
// 339  244
// 340  249
// 341  246
// 342  244
// 343  243
// 344  245
// 345  245
// 346  245
// 347  250
// 348  250
// 349  250
// 350  247
// 351  246
// 352  245
// 353  247
// 354  247
// 355  247
// 356  247
// 357  246
// 358  244
// 359  245
// 360  243
// 361  246
// 362  247
// 363  242
// 364  243
// 365  247
// 366  243
// 367  245
// 368  376             //third miss ( third miss - second miss ==> 368 - 240 = 128
// 369  245
// 370  241
// 371  244
// 372  247
// 373  241
// 374  243
// 375  244
// 376  240
// 377  246
// 378  245
// 379  246
// 380  246
// 381  242
// 382  244
// 383  246
// 384  244
// 385  249
// 386  241
// 387  244
// 388  243
// 389  245
// 390  243
// 391  247
// 392  245
// 393  249
// 394  245
// 395  248
// 396  244
// 397  245
// 398  244
// 399  246
// 400  243
// 401  245
// 402  243
// 403  245
// 404  243
// 405  247
// 406  244
// 407  245
// 408  246
// 409  247
// 410  249
// 411  247
// 412  248
// 413  248
// 414  244
// 415  245
// 416  242
// 417  246
// 418  246
// 419  247
// 420  246
// 421  248
// 422  246
// 423  244
// 424  246
// 425  244
// 426  242
// 427  246
// 428  247
// 429  245
// 430  246
// 431  245
// 432  249
// 433  247
// 434  244
// 435  245
// 436  247
// 437  248
// 438  245
// 439  246
// 440  243
// 441  241
// 442  241
// 443  246
// 444  244
// 445  243
// 446  247
// 447  245
// 448  245
// 449  243
// 450  246
// 451  245
// 452  246
// 453  247
// 454  243
// 455  244
// 456  244
// 457  245
// 458  248
// 459  248
// 460  247
// 461  249
// 462  249
// 463  245
// 464  248
// 465  246
// 466  244
// 467  248
// 468  247
// 469  245
// 470  247
// 471  245
// 472  249
// 473  244
// 474  245
// 475  247
// 476  247
// 477  249
// 478  248
// 479  249
// 480  249
// 481  250
// 482  247
// 483  247
// 484  247
// 485  246
// 486  244
// 487  243
// 488  246
// 489  246
// 490  246
// 491  246
// 492  248
// 493  248
// 494  246
// 495  250
// 496  251
// 497  245
// 498  246
// 499  243
// 500  248
// 501  247
// 502  243
// 503  248
// 504  244
// 505  245
// 506  242
// 507  246
// 508  244
// 509  246
// 510  245
// 511  249

// ############### so we can conclude that block size is 128 ##################